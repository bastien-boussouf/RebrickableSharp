parameters:
  - name: rootNamespace
    type: string

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'  
  semVerDate: $(Get-Date -Format yyyyMMdd+HHmmss)
  pathToLibDir: '$(System.DefaultWorkingDirectory)\$(parameters.rootNamespace)\'
  pathToLibCsproj: '$(pathToLibDir)$(parameters.rootNamespace).csproj'
  buildScriptsPath: "$(System.DefaultWorkingDirectory)/Build"
  directoryBuildPropsPath: "$(System.DefaultWorkingDirectory)/Directory.Build.props"

steps:
- task: NuGetToolInstaller@1

- task: NuGetCommand@2
  displayName: 'Restore NuGet packages - $(parameters.rootNamespace)'
  inputs:
    command: 'restore'
    restoreSolution: $(solution)
    feedsToUse: 'select'

- task: PowerShell@2
  displayName: 'Update CSPROJ Files - $(parameters.rootNamespace)'
  inputs:
    filePath: "$(buildScriptsPath)/patch-build-props.ps1"
    arguments: '-DirectoryBuildPropsPath $(directoryBuildPropsPath) -BuildId $(Build.BuildId) -InformationalVersionSuffix "$(semVerDate)"'
    
- task: PowerShell@2
  displayName: 'Update Build Number From Version - $(parameters.rootNamespace)'
  inputs:
    filePath: "$(buildScriptsPath)/update-build-number-from-version.ps1"
    arguments: "-PathToCsprojFile $(directoryBuildPropsPath)"
    
- task: DotNetCoreCLI@2
  displayName: 'Build Solution And Create NuGet Package - $(parameters.rootNamespace)'
  inputs:
    command: 'pack'
    packagesToPack: '${{ parameters.pathToLibCsproj }}'
    versioningScheme: 'off'
    packDirectory: '${{ parameters.pathToLibDir }}bin\$(buildConfiguration)'

- task: CopyFiles@2
  displayName: 'Copy Bin To ArtifactsStagingDirectory - $(parameters.rootNamespace)'
  inputs:
      SourceFolder: '$(System.DefaultWorkingDirectory)'
      Contents: '${{ parameters.rootNamespace }}\bin\$(BuildConfiguration)\**'
      TargetFolder: '$(Build.ArtifactsStagingDirectory)'      

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifacts - $(parameters.rootNamespace)'
  inputs:
      PathtoPublish: '$(Build.ArtifactsStagingDirectory)'
      ArtifactName: 'drop'
      publishLocation: 'Container'